
events {
    # 1024 is a good default for moderate traffic
    worker_connections 1024;
}

# HTTP block - main configuration for web server
http {
    # Include MIME types file (defines content types like text/html, image/png, etc.)
    include /etc/nginx/mime.types;
    
    # Default content type for files without recognized extension
    default_type application/octet-stream;

    # Server block for HTTPS (port 443) 
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        
        # Domain names this server responds to
        server_name hheng.42.fr www.hheng.42.fr;

        # SSL/TLS Configuration - REQUIRED by subject (TLSv1.2 or TLSv1.3 only)
        ssl_certificate /etc/ssl/certs/nginx.crt;           # Public certificate
        ssl_certificate_key /etc/ssl/private/nginx.key;     # Private key
        ssl_protocols TLSv1.2 TLSv1.3;                      # Only secure protocols

        # Root directory containing WordPress files (shared volume with WordPress container)
        root /var/www/wordpress;
        
        # Default files to serve when directory is requested
        index index.php index.html index.htm;

        # Main location block - handles all requests
        # Supports WordPress pretty permalinks (e.g., /blog/my-post instead of ?p=123)
        location / {
            # Try file directly, then directory, then pass to index.php with query string
            try_files $uri $uri/ /index.php?$args;
        }

        # PHP processing via FastCGI - NGINX cannot execute PHP, needs PHP-FPM
        # Matches any URL ending in .php
        location ~ \.php$ {
            # Security: return 404 if PHP file doesn't exist (prevents script injection)
            try_files $uri =404;
            
            # Split path info for PHP scripts (e.g., /script.php/path/info)
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            
            # Forward request to WordPress container PHP-FPM on port 9000
            # 'wordpress' is the container name, resolved via Docker network
            fastcgi_pass wordpress:9000;
            
            # Default index file for PHP
            fastcgi_index index.php;
            
            # Include standard FastCGI parameters
            include fastcgi_params;
            
            # Tell PHP-FPM the full path to the script file
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            
            # Pass path info to PHP (for URLs like /index.php/some/path)
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }

    # Block HTTP access (port 80) - REQUIRED by evaluation sheet
    # Evaluation requirement: "Try to access via http (port 80) and verify you cannot connect"
    # This ensures ONLY HTTPS (port 443) is accessible
    server {
        # Listen on port 80 (HTTP) for IPv4 and IPv6
        listen 80;
        listen [::]:80;
        
        # Same domain names as HTTPS server
        server_name hheng.42.fr www.hheng.42.fr;
        
        # Return 444 (non-standard): close connection without response
        # This makes HTTP completely inaccessible (connection refused)
        return 444;
    }
}